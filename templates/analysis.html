{% extends 'layout.html' %}

{% block title %}Analisis Sentimen{% endblock %}

{% block page_title %}Analisis Sentimen{% endblock %}

{% block content %}
    <p style="font-size: 1.1em; margin-top: -1rem; margin-bottom: 2rem; font-weight: 500;">
        Gunakan bagian ini untuk menganalisis sentimen dari teks tunggal atau mengunggah file untuk analisis massal.
    </p>

    <!-- Menampilkan Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}" role="alert">
                    <div>
                        <i class="alert-icon fas {% if category == 'danger' %}fa-exclamation-triangle{% else %}fa-check-circle{% endif %}"></i>
                        {{ message }}
                    </div>
                    <button type="button" class="alert-close">&times;</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {# Embed JSON data #}
    <script id="sentiment-data" type="application/json">{% if sentiment_counts %}{{ sentiment_counts | tojson | safe }}{% else %}null{% endif %}</script>

    <!-- Bagian 1: Analisis Teks Tunggal -->
    <div class="card">
        <h2>Analisis Teks Tunggal</h2>
        <p>Masukkan sebuah kalimat atau paragraf dalam bahasa Indonesia untuk dianalisis.</p>

        <form method="POST" action="{{ url_for('analysis') }}">
            <div class="form-group">
                <label for="text_input_area">Teks Anda:</label>
                <textarea name="text_input" id="text_input_area" rows="6" class="form-control"
                          placeholder="Ketik atau tempel teks Anda di sini...">{{ text }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-bolt"></i> Analisis Teks
            </button>
        </form>

        <!-- Hasil Prediksi -->
        {% if prediction %}
            <div class="result-block">
                <h2 style="font-size: 1.2rem; margin-bottom: 1rem; border: none; background: none; padding: 0;">HASIL ANALISIS:</h2>
                <h3>{{ prediction }}</h3>
            </div>
        {% endif %}
    </div>

    <!-- Bagian 2: Analisis File Massal -->
    <div class="card">
        <h2>Analisis File (CSV/XLSX)</h2>
        <p>Upload file untuk analisis sentimen massal.</p>
        
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('analysis') }}" id="file-analysis-form">
            <div class="form-group">
                <label for="file">Pilih File:</label>
                <input type="file" name="file" id="file" class="form-control-file" required>
            </div>
            <div class="form-group">
                <label for="text_column">Nama Kolom Teks:</label>
                <input type="text" name="text_column" id="text_column" class="form-control" placeholder="Contoh: 'tweet_text'" required>
            </div>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-file-upload"></i> Upload & Proses
            </button>
        </form>

        {% if sentiment_counts %}
            <div class="results-container" style="margin-top: 3rem;">
                <h2 style="font-size: 2rem; margin-bottom: 20px; text-decoration: underline;">VISUALISASI HASIL</h2>
                <div class="charts-grid">
                    
                    <!-- Bar Chart -->
                    <div class="chart-box">
                        <h3>Distribusi Sentimen</h3>
                        <canvas id="barChartCanvas"></canvas>
                    </div>
                    
                    <!-- Pie Chart -->
                    <div class="chart-box">
                        <h3>Proporsi Sentimen</h3>
                        <div style="position: relative; max-height: 400px; margin: auto;">
                            <canvas id="pieChartCanvas"></canvas>
                        </div>
                    </div>
                </div>

                {% if wordcloud %}
                <div class="chart-box" style="width: 100%; margin-bottom: 30px;">
                    <h3>Word Cloud</h3>
                    <img src="data:image/png;base64,{{ wordcloud }}" alt="Word Cloud" style="max-width: 100%; border: 2px solid #000;">
                </div>
                {% endif %}

                <h2 style="font-size: 1.5rem; margin-top: 2rem;">Data Tabel</h2>
                <div class="table-responsive">
                    {{ results_table|safe }}
                </div>
            </div>
        {% endif %}
    </div>

{% endblock %}

<!-- Script Khusus untuk Chart Neo-Brutalism -->
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileForm = document.getElementById('file-analysis-form');
        const spinnerOverlay = document.getElementById('spinner-overlay');

        if (fileForm) {
            fileForm.addEventListener('submit', function() {
                const fileInput = document.getElementById('file');
                const columnInput = document.getElementById('text_column');
                if (fileInput.value && columnInput.value && spinnerOverlay) {
                    spinnerOverlay.style.display = 'flex'; // Gunakan flex agar center
                    spinnerOverlay.classList.remove('hidden');
                }
            });
        }

        const countsEl = document.getElementById('sentiment-data');
        let counts = null;

        if (countsEl) {
            try {
                counts = JSON.parse(countsEl.textContent || 'null');
            } catch (e) {
                console.error("Gagal mem-parsing data sentimen:", e);
                counts = null;
            }
        }
        
        if (counts && Object.keys(counts).length > 0) {
            // Setup Data
            const labels = ['Positif', 'Netral', 'Negatif'];
            const data = [
                counts['Positif'] || 0,
                counts['Netral'] || 0,
                counts['Negatif'] || 0
            ];
            
            // Warna Neo-Brutalism
            const bgColors = [
                '#00E676', // Hijau
                '#d1d1d1', // Abu
                '#FF5252'  // Merah
            ];
            
            const borderColors = '#000000'; // Border Hitam Pekat
            const borderWidth = 3;          // Border Tebal

            // Config Font
            Chart.defaults.font.family = "'Space Grotesk', sans-serif";
            Chart.defaults.color = '#000';

            // 4. Buat Bar Chart
            const barCtx = document.getElementById('barChartCanvas');
            if (barCtx) {
                new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Jumlah',
                            data: data,
                            backgroundColor: bgColors,
                            borderColor: borderColors,
                            borderWidth: borderWidth,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#000', lineWidth: 1 },
                                ticks: { color: '#000', font: { weight: 'bold' } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#000', font: { weight: 'bold' } }
                            }
                        }
                    }
                });
            }

            // 5. Buat Pie Chart
            const pieCtx = document.getElementById('pieChartCanvas');
            if (pieCtx) {
                new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: bgColors,
                            borderColor: borderColors,
                            borderWidth: borderWidth
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#000', font: { weight: 'bold' } }
                            }
                        }
                    }
                });
            }
        }
    });
</script>
{% endblock %}